<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>äº‘ç«¯å‰ªè´´æ¿ | Cloud Clipboard</title>
    <style>
        /* å¼•å…¥æ€æºé»‘ä½“ä½œä¸ºé»˜è®¤ä¸­æ–‡å­—ä½“ï¼Œæå‡ç®€çº¦æ„Ÿ */
        @font-face {
            font-family: 'PingFangSC-Regular';
            src: local('PingFang SC'), local('PingFangSC-Regular'), local('Heiti SC'), local('Microsoft YaHei');
        }
        body {
            font-family: 'PingFangSC-Regular', Arial, sans-serif;
            background-color: #f5f5f7; /* æ¥è¿‘ Apple çš„æµ…ç°è‰²èƒŒæ™¯ */
            text-align: center;
            padding: 40px 20px;
            color: #1d1d1f; /* æ¥è¿‘ Apple çš„æ·±è‰²æ–‡å­— */
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            text-align: left;
        }
        h2, h3 {
            color: #1d1d1f;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button {
            padding: 12px 20px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-weight: 500;
        }
        button:hover {
            background: #0066ff;
        }
        button:active {
            transform: scale(0.99);
        }
        /* å¸ƒå±€åˆ†åŒº */
        .content-sections {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        /* ä¸‰ä¸ªåŒºåŸŸçš„å®½åº¦åˆ†é… */
        .current-clipboard-section {
            flex: 1.2;
        }
        .history-section {
            flex: 2;
            display: flex;
            gap: 20px;
        }
        .section {
            padding: 20px;
            border-radius: 10px;
        }
        /* å„åˆ†åŒºæ ·å¼ */
        .current-clipboard-section, .history-list {
            background-color: #ffffff;
            border: 1px solid #d2d2d7;
        }
        .history-list {
            flex: 1;
        }
        .current-clipboard-section .message-card {
             border-left: 4px solid #34c759;
        }
        .messages {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 8px;
            background: #f7f7f7;
            border: 1px solid #e0e0e5;
        }
        /* å•ä¸ªç•™è¨€å¡ç‰‡ */
        .message-card {
            background: #ffffff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            border-left: 4px solid #007aff;
        }
        .message-card.public {
            border-left: 4px solid #5ac8fa;
        }
        .message-card.private {
            border-left: 4px solid #ff9500;
        }
        .message-card p {
            margin: 5px 0;
        }
        .copy-btn, .delete-btn {
            float: right;
            margin-left: 10px;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
        }
        .copy-btn {
            background: #34c759;
        }
        .copy-btn:hover {
            background: #2cb742;
        }
        .delete-btn {
            background: #ff3b30;
        }
        .delete-btn:hover {
            background: #cc2925;
        }
        /* å¯†ç é®ç½© */
        .blur-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8e8e93;
            font-weight: 500;
            border-radius: 8px;
            z-index: 10;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .blur-overlay:hover {
            opacity: 0.9;
        }
        
        /* â­ æ–°å¢æ ·å¼ï¼šå±…ä¸­é®ç½©å±‚çš„å†…å®¹ */
        .blur-overlay .overlay-content {
            text-align: center;
            padding: 10px; 
            max-width: 90%; 
            word-wrap: break-word;
        }

        /* é”™è¯¯åé¦ˆæ ·å¼ - ä¿ç•™ç”¨äºå±€éƒ¨çš„å¯†ç è¾“å…¥é”™è¯¯åé¦ˆ */
        .error-feedback {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3b30;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Toast Notification æ ·å¼ */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toast {
            min-width: 250px;
            padding: 10px 20px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px);
            font-size: 15px;
            font-weight: 500;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ... ä¿æŒåŸæœ‰çš„ CSS æ ·å¼ ... */

/* æ–°å¢ï¼šç§»åŠ¨ç«¯é€‚é… (Media Query) */
@media (max-width: 768px) {
    /* ç¼©å°æ•´ä½“å®¹å™¨å®½åº¦ */
    .container {
        padding: 20px;
        margin: 10px;
    }

    /* å†å²è®°å½•åŒºåŸŸï¼šä»æ°´å¹³ Flex æ”¹ä¸ºå‚ç›´å †å  */
    .content-sections {
        flex-direction: column; /* ä¸»è¦åŒºåŸŸå‚ç›´å †å  */
        gap: 25px; /* å¢åŠ åŒºåŸŸé—´è· */
    }
    
    /* å†å²åˆ—è¡¨ï¼šå‚ç›´å †å  */
    .history-section {
        flex-direction: column; /* å†å²åŒºå†…éƒ¨å‚ç›´å †å  */
        gap: 25px;
    }

    /* å½“å‰å‰ªè´´æ¿ï¼šå®½åº¦å æ»¡ */
    .current-clipboard-section {
        flex: 1 1 100%;
    }
    
    /* å†å²åˆ—è¡¨ï¼šå®½åº¦å æ»¡ */
    .history-list {
        flex: 1 1 100%;
    }
    
    /* å¼ºè°ƒæœ€æ–°å†…å®¹ */
    #latestPublicMessage p {
        font-size: 24px !important; /* åŠ å¤§æœ€æ–°å†…å®¹çš„å­—å· */
        padding: 10px 0;
    }
}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="container">
        <h2>äº‘ç«¯å‰ªè´´æ¿</h2>

        <div class="input-area">
            <input type="text" id="titleInput" placeholder="è¯·è¾“å…¥å†…å®¹æ ‡é¢˜/ç®€ä»‹ï¼ˆå¯é€‰ï¼‰">
            <textarea id="messageInput" placeholder="è¾“å…¥å†…å®¹..."></textarea>
            <input type="password" id="password" placeholder="è®¾ç½®æŸ¥çœ‹å¯†ç ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä¸ºå…¬å¼€ï¼‰">
            <button onclick="submitMessage()">æäº¤å†…å®¹</button>
        </div>

        <div class="content-sections">
            <div class="section current-clipboard-section">
                <h3>å½“å‰å‰ªè´´æ¿ (æœ€æ–°å…¬å¼€å†…å®¹)</h3>
                <div id="latestPublicMessage" class="message-card public">
                    <p>ç­‰å¾…å†…å®¹åŒæ­¥...</p>
                </div>
                <button class="copy-btn" onclick="copyLatestContent()">ä¸€é”®å¤åˆ¶</button>
            </div>

            <div class="history-section">
                <div class="history-list">
                    <h3>æ—§å…¬å¼€å†…å®¹</h3>
                    <div class="messages" id="publicMessages">
                        <p style="text-align: center; color: #8e8e93;">æ‰€æœ‰æ—§çš„æœªåŠ å¯†å†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</p>
                    </div>
                </div>
                
                <div class="history-list">
                    <h3>åŠ å¯†å†…å®¹</h3>
                    <div class="messages" id="privateMessages">
                        <p style="text-align: center; color: #8e8e93;">æ‰€æœ‰è®¾ç½®äº†å¯†ç çš„å†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, limitToLast, remove } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

        // ğŸš¨ é‡è¦ï¼šè¿™æ˜¯ç»ˆæå¯†ç 
        const ULTIMATE_PASSWORD = "myUltimateKey123"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDsZ-VZ7lzklLTlfizbSeVMEC5QjdLnhrY",
            authDomain: "interoperability-b22f0.firebaseapp.com",
            databaseURL: "https://interoperability-b22f0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "interoperability-b22f0",
            storageBucket: "interoperability-b22f0.appspot.com",
            messagingSenderId: "697557753503",
            appId: "1:697557753503:web:51b241fb83083ba32bccaa"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // --- æ ¸å¿ƒå®‰å…¨: SHA-256 å“ˆå¸Œå‡½æ•° ---
        async function hashPassword(password) {
            if (!password) return "";
            
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return hashHex;
        }
        // ------------------------------------

        // --- Toast Notification è¾…åŠ©å‡½æ•° ---
        function showToast(message, duration = 2000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                }, { once: true });
            }, duration);
        }
        // ------------------------------------


        // æäº¤å†…å®¹ (å¼‚æ­¥)ï¼šæ–°å¢æ ‡é¢˜é€»è¾‘
        window.submitMessage = async function () {
            const title = document.getElementById("titleInput").value.trim(); // è·å–æ ‡é¢˜
            const message = document.getElementById("messageInput").value.trim();
            const password = document.getElementById("password").value.trim();

            if (!message) {
                alert("å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            const hashedPassword = await hashPassword(password);
            const isPrivate = !!password; 

            const messageRef = push(ref(database, "clipboard"));
            set(messageRef, {
                title: title, // ä¿å­˜æ ‡é¢˜
                text: message,
                password: hashedPassword, 
                timestamp: Date.now(),
                isPrivate: isPrivate
            }).then(() => {
                document.getElementById("titleInput").value = ""; // æ¸…ç©ºæ ‡é¢˜è¾“å…¥æ¡†
                document.getElementById("messageInput").value = "";
                document.getElementById("password").value = "";
            }).catch(error => {
                console.error("æäº¤å¤±è´¥: ", error);
                alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚");
            });
        };

        // ä¸€é”®å¤åˆ¶æœ€æ–°å†…å®¹ - ä¿ç•™æˆåŠŸæç¤º
        window.copyLatestContent = async function() {
            const latestDiv = document.getElementById("latestPublicMessage");
            const textToCopy = latestDiv.dataset.content || "";
            
            if (!textToCopy) return;

            try {
                await navigator.clipboard.writeText(textToCopy);
                showToast("å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿"); 
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
            }
        };

        // åˆ—è¡¨ä¸­çš„å¤åˆ¶æŒ‰é’®åŠŸèƒ½ - ä¿ç•™æˆåŠŸæç¤º
        window.copyContentFromList = async function(button, messageId, isPrivate) {
            const messageCard = button.closest('.message-card');
            let textToCopy = messageCard.dataset.decryptedContent;

            if (isPrivate && !textToCopy) {
                alert("è¿™æ˜¯åŠ å¯†å†…å®¹ï¼Œè¯·å…ˆç‚¹å‡»é®ç½©è¾“å…¥å¯†ç æŸ¥çœ‹");
                return;
            }
            
            if (textToCopy) {
                 try {
                    await navigator.clipboard.writeText(textToCopy);
                    showToast("å·²æˆåŠŸå¤åˆ¶è§£å¯†å†…å®¹");
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }
            } else {
                const messageRef = ref(database, "clipboard/" + messageId);
                onValue(messageRef, async (snapshot) => {
                    const data = snapshot.val();
                    if (data && !data.isPrivate) {
                        try {
                            await navigator.clipboard.writeText(data.text);
                            showToast("å·²æˆåŠŸå¤åˆ¶å†å²å†…å®¹"); 
                        } catch (err) {
                            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                        }
                    }
                }, { onlyOnce: true });
            }
        };

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå¯†ç é”™è¯¯æç¤º (å±€éƒ¨åé¦ˆ)
        function showPasswordError(overlay) {
            let errorDiv = overlay.querySelector('.error-feedback');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-feedback';
                errorDiv.textContent = 'å¯†ç é”™è¯¯';
                overlay.appendChild(errorDiv);
            }
            errorDiv.style.opacity = 1;
            setTimeout(() => {
                errorDiv.style.opacity = 0;
            }, 1000);
        }

        // åˆ é™¤ç•™è¨€å‡½æ•° - æˆåŠŸæ—¶ä¸æç¤ºï¼Œå¤±è´¥æ—¶æç¤º
        window.deleteMessage = function (messageId, isPrivate) {
            
            if (!isPrivate) { 
                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å¼€å†…å®¹å—ï¼Ÿ")) { 
                    const messageRef = ref(database, "clipboard/" + messageId);
                    remove(messageRef); 
                }
                return;
            }
            
            const password = prompt("è¿™æ˜¯åŠ å¯†å†…å®¹ã€‚è¯·è¾“å…¥åˆ é™¤å¯†ç ï¼š");
            const correctDeletePassword = "19142"; 
            
            if (password === correctDeletePassword) {
                const messageRef = ref(database, "clipboard/" + messageId);
                remove(messageRef);
            } else if (password !== null) { 
                showToast("åˆ é™¤å¯†ç é”™è¯¯ï¼"); 
            }
        };


        // æ¸²æŸ“æœ€æ–°å…¬å¼€å†…å®¹å’Œå†å²è®°å½•ï¼šä½¿ç”¨æ ‡é¢˜è¿›è¡Œå±•ç¤º
        const clipboardRef = ref(database, "clipboard");
        onValue(query(clipboardRef, limitToLast(50)), (snapshot) => { 
            const publicMessagesDiv = document.getElementById("publicMessages");
            const privateMessagesDiv = document.getElementById("privateMessages");
            const latestPublicDiv = document.getElementById("latestPublicMessage");
            
            publicMessagesDiv.innerHTML = "";
            privateMessagesDiv.innerHTML = "";

            let latestPublicFound = false;
            const allMessages = [];

            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                data.id = childSnapshot.key;
                allMessages.push(data);
            });

            allMessages.reverse().forEach((data) => {
                // 1. å¤„ç†æœ€æ–°å‰ªè´´æ¿åŒºåŸŸ
                if (!data.isPrivate && !latestPublicFound) {
                    latestPublicDiv.innerHTML = `<p style="font-size: 18px; font-weight: 600;">${data.text}</p>`;
                    latestPublicDiv.dataset.content = data.text; 
                    latestPublicFound = true;
                    return; 
                }

                // 2. æ¸²æŸ“å†å²åˆ—è¡¨é¡¹
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message-card");
                
                let targetDiv = null;
                // ä¼˜å…ˆä½¿ç”¨æ ‡é¢˜ï¼Œå¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œåˆ™æˆªæ–­å†…å®¹ä½œä¸ºç®€ä»‹
                let displayTitle = data.title || data.text.substring(0, 30) + (data.text.length > 30 ? "..." : ""); 
                let previewText = "å†…å®¹è¯¦æƒ…..."; // é»˜è®¤å†…å®¹ç®€ä»‹

                if (data.isPrivate) {
                    messageDiv.classList.add("private");
                    targetDiv = privateMessagesDiv;
                    previewText = "åŠ å¯†å†…å®¹ (éœ€è§£é”)"; 
                } else {
                    messageDiv.classList.add("public");
                    targetDiv = publicMessagesDiv;
                    previewText = data.text.substring(0, 30) + (data.text.length > 30 ? "..." : ""); // å…¬å¼€å†…å®¹æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹
                }
                
                messageDiv.innerHTML = `
                    <p style="font-weight: 600; margin-bottom: 5px; color: #1d1d1f;">æ ‡é¢˜: ${displayTitle}</p> <p style="font-size: 14px; color: ${data.isPrivate ? '#ff9500' : '#4a4a4a'};">å†…å®¹: ${previewText}</p>
                    <p style="font-size: 12px; color: #8e8e93;">æ—¶é—´: ${new Date(data.timestamp).toLocaleString()}</p>
                    <button class="delete-btn" onclick="deleteMessage('${data.id}', ${data.isPrivate})">åˆ é™¤</button> 
                    <button class="copy-btn" onclick="copyContentFromList(this, '${data.id}', ${data.isPrivate})">å¤åˆ¶/æŸ¥çœ‹</button>
                `;
                
                if (data.isPrivate) {
                    const overlay = document.createElement("div");
                    overlay.className = "blur-overlay";
                    
                    // â­ ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ innerHTML æ˜¾ç¤ºæ ‡é¢˜å’Œæç¤º
                    overlay.innerHTML = `
                        <div class="overlay-content">
                            <p style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">${displayTitle}</p>
                            <p style="font-size: 14px; margin: 0;">ç‚¹å‡»è¾“å…¥å¯†ç æŸ¥çœ‹/å¤åˆ¶</p>
                        </div>
                    `;

                    overlay.onclick = async () => { 
                        const inputPwd = prompt("è¯·è¾“å…¥å¯†ç æŸ¥çœ‹è¯¥å†…å®¹ï¼š");
                        
                        if (inputPwd === null) return; 

                        if (inputPwd === ULTIMATE_PASSWORD) {
                            overlay.remove();
                            messageDiv.querySelector('p').innerHTML = `å†…å®¹: ${data.text}`;
                            messageDiv.dataset.decryptedContent = data.text; 
                            return;
                        } 
                        
                        const hashedInput = await hashPassword(inputPwd); 
                        
                        if (hashedInput === data.password) {
                            overlay.remove();
                            messageDiv.querySelector('p').innerHTML = `å†…å®¹: ${data.text}`;
                            messageDiv.dataset.decryptedContent = data.text; 
                        } else {
                            showPasswordError(overlay);
                        }
                    };
                    messageDiv.appendChild(overlay);
                }

                targetDiv.appendChild(messageDiv);
            });

            if (!latestPublicFound) {
                latestPublicDiv.innerHTML = `<p style="color: #8e8e93;">æš‚æ— å…¬å¼€å†…å®¹ï¼Œè¯·æäº¤æ–°å†…å®¹ã€‚</p>`;
                latestPublicDiv.dataset.content = "";
            }
            
            [publicMessagesDiv, privateMessagesDiv].forEach(list => {
                const cards = Array.from(list.children);
                list.innerHTML = "";
                cards.reverse().forEach(card => list.appendChild(card));
            });
            
            if (publicMessagesDiv.children.length === 0) {
                 publicMessagesDiv.innerHTML = `<p style="text-align: center; color: #8e8e93;">æ‰€æœ‰æ—§çš„æœªåŠ å¯†å†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„ã€‚</p>`;
            }
             if (privateMessagesDiv.children.length === 0) {
                 privateMessagesDiv.innerHTML = `<p style="text-align: center; color: #8e8e93;">æ‰€æœ‰è®¾ç½®äº†å¯†ç çš„å†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„ã€‚</p>`;
            }
        });

    </script>
</body>
</html>
