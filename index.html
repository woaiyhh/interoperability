<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>云端剪贴板</title>
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --border: #d2d2d7;
            --blue: #007aff;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9500;
            --light: #8e8e93;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        .header { text-align: center; padding: 10px 0 20px; }
        h2 { margin: 0; font-size: 28px; font-weight: 600; }

        /* 输入区 */
        .input-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 12px;
        }
        textarea { min-height: 100px; resize: vertical; }
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 主内容区 - 响应式栅格 */
        .main-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }
        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 1.3fr 2fr;
            }
            .history-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: 1fr 2.2fr; }
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }
        h3 { margin: 0 0 16px 0; font-size: 18px; }

        /* 最新内容卡片 */
        #latestPublicMessage {
            min-height: 100px;
            padding: 16px;
            font-size: 18px;
            line-height: 1.5;
            word-break: break-all;
            background: #f9f9fb;
            border-radius: 12px;
            border-left: 5px solid #5ac8fa;
        }

        /* 历史列表 */
        .messages {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 4px;
        }
        .history-grid {
            display: grid;
            gap: 20px;
        }

        /* 统一消息卡片 - 关键自适应 */
        .msg {
            position: relative;
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border-left: 4px solid var(--blue);
            overflow: hidden;
        }
        .msg.public { border-left-color: #5ac8fa; }
        .msg.private { border-left-color: var(--orange); }

        .msg .btns {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 8px;
        }
        .msg .btns button {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .msg .copy { background: var(--green); color: white; }
        .msg .del { background: var(--red); color: white; }

        .msg .body {
            padding-top: 36px;
            padding-right: 90px;
            line-height: 1.5;
            word-break: break-all;
            user-select: none;
        }
        .msg .body p {
            margin: 0 0 8px 0;
        }
        .msg .body p:first-child {
            font-weight: 600;
            font-size: 15px;
            color: var(--text);
        }
        .msg .body p:nth-child(2) {
            color: #333;
            font-size: 14px;
        }
        .msg .body p:last-child {
            font-size: 12px;
            color: var(--light);
            margin-bottom: 0;
        }

        /* 加密遮罩 */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.97);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            cursor: pointer;
            z-index: 9;
        }
        .overlay p { margin: 4px 0; }

        /* Toast */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div class="header"><h2>云端剪贴板</h2></div>

    <!-- 输入区 -->
    <div class="input-card">
        <input type="text" id="titleInput" placeholder="标题（可选）">
        <textarea id="messageInput" placeholder="输入要同步的内容..."></textarea>
        <input type="password" id="password" placeholder="查看密码（留空则公开）">
        <button class="submit-btn" onclick="submitMessage()">提交内容</button>
    </div>

    <!-- 主内容区 -->
    <div class="main-grid">
        <!-- 最新公开内容 -->
        <div class="card">
            <h3>当前剪贴板（最新公开）</h3>
            <div id="latestPublicMessage">等待内容同步...</div>
            <button class="submit-btn" onclick="copyLatestContent()" style="margin-top:12px;background:#34c759;">一键复制</button>
        </div>

        <!-- 历史内容 -->
        <div class="card">
            <h3>历史记录</h3>
            <div class="history-grid">
                <div>
                    <h3 style="margin:0 0 12px;font-size:16px;color:#555;">公开内容</h3>
                    <div class="messages" id="publicMessages">
                        <p style="text-align:center;color:var(--light);padding:20px 0;">暂无公开内容</p>
                    </div>
                </div>
                <div>
                    <h3 style="margin:0 0 12px;font-size:16px;color:#555;">加密内容</h3>
                    <div class="messages" id="privateMessages">
                        <p style="text-align:center;color:var(--light);padding:20px 0;">暂无加密内容</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, query, limitToLast, remove } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

    const ULTIMATE_PASSWORD = "myUltimateKey123";
    const DELETE_PASSWORD = "19142";

    const app = initializeApp({
        apiKey: "AIzaSyDsZ-VZ7lzklLTlfizbSeVMEC5QjdLnhrY",
        databaseURL: "https://interoperability-b22f0-default-rtdb.asia-southeast1.firebasedatabase.app"
    });
    const db = getDatabase(app);

    function toast(msg) {
        const t = document.createElement('div');
        t.className = 'toast show';
        t.textContent = msg;
        document.getElementById('toast').appendChild(t);
        setTimeout(() => t.remove(), 2200);
    }

    async function hash(p) {
        if (!p) return "";
        const e = new TextEncoder();
        const h = await crypto.subtle.digest('SHA-256', e.encode(p));
        return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    window.submitMessage = async () => {
        const title = document.getElementById('titleInput').value.trim();
        const text = document.getElementById('messageInput').value.trim();
        const pwd = document.getElementById('password').value.trim();
        if (!text) return alert('内容不能为空');

        const hashed = await hash(pwd);
        await set(push(ref(db, 'clipboard')), {
            title: title || "",
            text,
            password: hashed,
            timestamp: Date.now(),
            isPrivate: !!pwd
        });

        document.querySelectorAll('#titleInput,#messageInput,#password').forEach(el => el.value = '');
        toast('提交成功');
    };

    window.copyLatestContent = () => {
        const text = document.getElementById('latestPublicMessage').dataset.text || '';
        if (text) navigator.clipboard.writeText(text).then(() => toast('已复制'));
    };

    const render = snapshot => {
        const pub = document.getElementById('publicMessages');
        const pri = document.getElementById('privateMessages');
        const latest = document.getElementById('latestPublicMessage');
        pub.innerHTML = pri.innerHTML = '';

        let hasLatest = false;
        const items = [];

        snapshot.forEach(s => {
            const d = s.val();
            d.id = s.key;
            items.push(d);
        });

        items.reverse().forEach(d => {
            if (!d.isPrivate && !hasLatest) {
                latest.textContent = d.text;
                latest.dataset.text = d.text;
                hasLatest = true;
            }

            const card = document.createElement('div');
            card.className = `msg ${d.isPrivate ? 'private' : 'public'}`;

            const title = d.title || d.text.slice(0, 30) + (d.text.length > 30 ? '...' : '');
            const preview = d.isPrivate ? '加密内容（点击输入密码查看）' : d.text.slice(0, 80) + (d.text.length > 80 ? '...' : '');

            card.innerHTML = `
                <div class="btns">
                    <button class="del" onclick="del('\( {d.id}', \){d.isPrivate})">删除</button>
                    <button class="copy" onclick="copy(this,'\( {d.id}', \){d.isPrivate})">复制</button>
                </div>
                <div class="body">
                    <p>${title || '无标题'}</p>
                    <p>${preview}</p>
                    <p>${new Date(d.timestamp).toLocaleString()}</p>
                </div>
            `;

            if (d.isPrivate) {
                const overlay = document.createElement('div');
                overlay.className = 'overlay';
                overlay.innerHTML = `<p style="font-weight:600">${title||'加密内容'}</p><p>点击输入密码查看</p>`;
                overlay.onclick = async () => {
                    const input = prompt('请输入密码：');
                    if (!input) return;
                    if (input === ULTIMATE_PASSWORD || await hash(input) === d.password) {
                        overlay.remove();
                        card.querySelector('.body p:nth-child(2)').textContent = d.text;
                        card.dataset.decrypted = d.text;
                    } else {
                        toast('密码错误');
                    }
                };
                card.appendChild(overlay);
            }

            (d.isPrivate ? pri : pub).appendChild(card);
        });

        if (!hasLatest) latest.textContent = '暂无公开内容';
        if (!pub.children.length) pub.innerHTML = '<p style="text-align:center;color:var(--light);padding:20px 0;">暂无公开内容</p>';
        if (!pri.children.length) pri.innerHTML = '<p style="text-align:center;color:var(--light);padding:20px 0;">暂无加密内容</p>';
    };

    window.copy = async (btn, id, isPrivate) => {
        const card = btn.closest('.msg');
        const decrypted = card.dataset.decrypted;
        if (decrypted) {
            await navigator.clipboard.writeText(decrypted);
            toast('已复制');
            return;
        }
        if (!isPrivate) {
            const snap = await get(ref(db, 'clipboard/'+id));
            await navigator.clipboard.writeText(snap.val().text);
            toast('已复制');
        }
    };

    window.del = (id, isPrivate) => {
        if (!isPrivate) {
            if (confirm('确定删除？')) remove(ref(db, 'clipboard/'+id));
            return;
        }
        const p = prompt('请输入删除密码：');
        if (p === DELETE_PASSWORD) remove(ref(db, 'clipboard/'+id));
        else if (p !== null) toast('删除密码错误');
    };

    onValue(query(ref(db, 'clipboard'), limitToLast(50)), render);
</script>
</body>
</html>